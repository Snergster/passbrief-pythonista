# PassBrief Onboarding Overview
Welcome aboard! You're stepping into PassBrief, a safety-first CLI engineered to help Cirrus SR22T crews translate dispatch-quality data into cockpit-ready briefings while keeping you in control of every decision.

## Mission and Value
PassBrief concentrates on the SR22T so every prompt, calculation, and guardrail aligns with that airframe's Pilot's Operating Handbook (POH) and real-world cockpit workflow. The refactored CLI is meant to feel like a seasoned safety pilot riding right-seat: it gathers the data, runs the math, and highlights risks, but you stay pilot-in-command.

- *(Certain)* Deliver SR22T-specific departure and arrival briefings that combine performance math, airport context, and dynamic weather into a single conversational flow (`src/passbrief/briefing/generator.py:28`).
- *(High confidence)* Support desktop and Pythonista workflows so instructors and owners can brief anywhere, even when disconnected, by leaning on embedded data and optional manual entry paths.
- *(Certain)* Bake in redundancy: every automated lookup (weather, magnetic variation, Garmin imports, AI analysis) has a manual fallback so the tool can never force a "no-go" because of connectivity.
- Potential obstacles to flag early: aviation vocabulary can be dense, performance calculations assume comfort with unit conversions, and some workflows expect familiarity with Cirrus-specific procedures. Keep a glossary handy and pace yourself through each briefing phase.

## Core Capabilities at a Glance
- *(Certain)* Safety-critical performance calculations—pressure/density altitude, wind components, climb gradients, and interpolated takeoff/landing distances—backed by embedded POH tables (`src/passbrief/performance/data.py:1`) orchestrated by `PerformanceCalculator` (`src/passbrief/performance/calculator.py:22`).
- *(High confidence)* METAR ingestion through NOAA with automatic unit conversion and age validation, paired with the ability to prompt for manual weather when data is stale or missing (`src/passbrief/weather/manager.py:31`).
- *(High confidence)* Garmin Pilot PDF import detection so recent briefings auto-populate the workflow when you launch `get_user_inputs()` (`src/passbrief/briefing/generator.py:82`), including intelligent prompts when key fields are missing.
- *(Certain)* Magnetic variation handling that prefers the NOAA WMM API, degrades to manual capture, and finally uses regional approximations to keep runway headings meaningful (`src/passbrief/airports/manager.py:49`).
- *(Certain)* CAPS (Cirrus Airframe Parachute System) altitude planning and departure-specific considerations generated by `CAPSManager` (`src/passbrief/briefing/caps.py:9`).
- *(High confidence)* SID (Standard Instrument Departure) awareness via `SIDManager` (`src/passbrief/briefing/sid.py:9`) so you can validate climb requirements against calculated performance.
- *(High confidence)* Phased takeoff brief flavor text that narrates actions for each altitude gate, helping transition from checklist to muscle memory (`src/passbrief/briefing/flavortext.py:9`).
- *(High confidence)* Optional ChatGPT-driven hazard and passenger brief analysis that activates only when an API key is loaded, never blocking core workflows (`src/passbrief/briefing/chatgpt.py:15`).

## How the Workflow Runs
`BriefingGenerator` (`src/passbrief/briefing/generator.py:28`) runs like a dispatcher: it owns the shared state, knows which manager answers which question, and exposes both guided and manual paths so you can recover from missing data without restarting the session.

### Phase Map by State
| Phase | Menu Option & Entry Point | Primary Inputs | Managers Activated | State Stored |
| --- | --- | --- | --- | --- |
| Weather & Route | `1` / `A` → `_weather_analysis_workflow()` (`src/passbrief/briefing/generator.py:214`) | Garmin PDF payload (`current_briefing_data`) | `GarminPilotBriefingManager`, `WeatherManager` | `weather_analysis_results` summary string (`src/passbrief/briefing/generator.py:288`) |
| Passenger Brief | `2` / `B` → `_passenger_briefing_workflow()` (`src/passbrief/briefing/generator.py:296`) | Cached Garmin data, optional AI availability | `ChatGPTAnalysisManager` (optional) | `passenger_brief_results` transcript |
| Takeoff Brief | `3` / `C` → `_takeoff_briefing_workflow()` (`src/passbrief/briefing/generator.py:332`) | Departure ICAO/runway, latest weather | `AirportManager`, `WeatherManager`, `PerformanceCalculator`, `CAPSManager`, `FlavorTextManager`, `SIDManager`, `ChatGPTAnalysisManager` (optional) | Formatted takeoff script and underlying performance dict |
| Arrival Brief | `4` / `D` → `_arrival_briefing_workflow()` (`src/passbrief/briefing/generator.py:389`) | Arrival ICAO/runway, weather | `AirportManager`, `WeatherManager`, `PerformanceCalculator`, `ChatGPTAnalysisManager` (optional) | Arrival briefing text |
| Sequential Run | `E` → `_full_sequential_workflow()` (`src/passbrief/briefing/generator.py:415`) | Reuses prior inputs; prompts when missing | All of the above | Aggregated outputs from each phase |

### Detailed Walkthrough
1. **Initialize and wire managers** *(Certain)* – Construction instantiates every manager (`src/passbrief/briefing/generator.py:32`) and primes the shared state containers so later phases can detect what has already been accomplished before prompting again.
2. **Scan for Garmin imports** *(Certain)* – `get_user_inputs()` (`src/passbrief/briefing/generator.py:82`) calls `self.garmin_manager.check_for_briefings()`, surfaces any PDFs with friendly timestamps, and normalizes missing ICAOs/routes via focused prompts. Selection persists to `current_briefing_data` so every downstream phase can assume a consistent dictionary shape.
3. **Surface the workflow menu** *(Certain)* – `_show_workflow_menu()` (`src/passbrief/briefing/generator.py:159`) displays phase status icons, quick shortcuts, and the sequential option. It reads the state containers to show ✅/⏸️ indicators and loops until the pilot picks the next task or quits.
4. **Weather & route analysis** *(High confidence)* – `_weather_analysis_workflow()` (`src/passbrief/briefing/generator.py:214`) validates that Garmin data exists, then combines it with fresh METAR pulls (`WeatherManager.fetch_metar()`). Results are summarized into `self.weather_analysis_results = f"Weather analysis completed for {departure} → {arrival}"` (`src/passbrief/briefing/generator.py:288`) so the menu reflects progress and later phases can confirm weather was reviewed.
5. **Passenger brief generation** *(High confidence)* – `_passenger_briefing_workflow()` (`src/passbrief/briefing/generator.py:296`) reuses `current_briefing_data`, asks whether to re-run analysis if weather hasn’t been captured, and, when `ChatGPTAnalysisManager.available` is true, produces a passenger-facing script stored in `passenger_brief_results`. Without AI, it still formats a concise manual brief using collected data.
6. **Takeoff brief production** *(Certain)* – `_takeoff_briefing_workflow()` (`src/passbrief/briefing/generator.py:332`) prompts for departure details when Garmin data is missing, normalizes runway identifiers (`_normalize_runway_input()`, `src/passbrief/briefing/generator.py:63`), retrieves airport magnetics and surfaces (`src/passbrief/airports/manager.py:414`), pulls METAR, then drives `_calculate_performance()` to obtain density altitude, climb gradients, and runway distances. It layers in CAPS guidance, optional SID requirements, flavor-text phases, and AI analysis before formatting the three-phase takeoff script.
7. **Arrival brief creation** *(High confidence)* – `_arrival_briefing_workflow()` (`src/passbrief/briefing/generator.py:389`) mirrors the takeoff logic for the destination, including manual fallbacks for runway and weather inputs and optional ChatGPT commentary for passenger situational awareness.
8. **Sequential run mode** *(Certain)* – `_full_sequential_workflow()` (`src/passbrief/briefing/generator.py:415`) chains the previous methods in order, short-circuiting if a step fails and reusing cached inputs so you aren’t retyping ICAOs. Ideal for “start to finish” rehearsals or when coaching a new pilot through the full brief.
9. **Manual workflows on demand** *(Certain)* – `_manual_departure_workflow()` (`src/passbrief/briefing/generator.py:1261`), `_manual_arrival_workflow()` (`src/passbrief/briefing/generator.py:1311`), and `_full_manual_workflow()` (`src/passbrief/briefing/generator.py:1336`) allow pure keyboard entry for environments without Garmin exports. They funnel into the same performance calculator, ensuring numbers remain consistent.
10. **AI integration remains optional** *(Certain)* – `generate_briefing()` only calls `ChatGPTAnalysisManager.generate_briefing_analysis()` when `self.chatgpt_manager.available` evaluates to `True` (`src/passbrief/briefing/generator.py:1414`), so missing API keys degrade gracefully with a clear “no AI augmentation” path.
11. **Common pitfalls & guardrails** – Double-check runway spellings (especially during manual entry), confirm METAR station proximity for remote airports, and remember that the cached state reflects the moment you ran a phase. If the weather changes, rerun the relevant workflow to refresh the stored summary before flying.


## Key Components and Responsibilities
- **BriefingGenerator (`src/passbrief/briefing/generator.py:28`)** *(Certain)* – Core conductor that keeps the four briefing phases in sync, persists intermediate results (`current_briefing_data`, `weather_analysis_results`, `passenger_brief_results`), and decides which manager to involve next. It also exposes every manual fallback path so you can switch from automated imports to hand-entered data without restarting a session.
- **Config (`src/passbrief/config.py:12`)** *(Certain)* – Central registry for all safety-critical constants: METAR age thresholds, magnetic variation retry windows, and rounding rules used by the performance math. Treat edits here like changing aircraft limitations—adjust only when you have matching test updates and operational justification.
- **PerformanceCalculator (`src/passbrief/performance/calculator.py:22`)** *(Certain)* – Converts weather plus runway context into actionable numbers: pressure altitude, density altitude, climb gradients, and runway distances by interpolating the POH tables in `performance/data.py`. It exposes helper test harnesses (`run_safety_critical_tests`) so you can verify your changes before trusting them in the field.
- **WeatherManager (`src/passbrief/weather/manager.py:20`)** *(High confidence)* – Talks to the NOAA METAR API, converts altimeter units, and tags each snapshot with age/source so you know whether the data was fresh, cached, or manually entered. When the network is unavailable it immediately pivots to structured prompts, keeping the workflow moving while documenting where the numbers came from.
- **AirportManager (`src/passbrief/airports/manager.py:41`)** *(Certain)* – Resolves runway geometry, surfaces, and magnetic headings. It stair-steps through WMM API lookup, user-provided magnetics, and regional approximations, recording the chosen path so later calculations (wind components, flavor text) always disclose their assumptions.
- **GarminPilotBriefingManager (`src/passbrief/garmin/pilot.py:13`)** *(High confidence)* – Scans Garmin-friendly directories (desktop and Pythonista alike), parses PDF briefings, and normalizes the output into `current_briefing_data`. If parsing fails, it guides the pilot through filling in missing fields, ensuring the rest of the workflow still has a consistent data contract.
- **SIDManager (`src/passbrief/briefing/sid.py:9`)** *(High confidence)* – Supplies runway-specific SID suggestions and climb requirements, acting as an early warning system when computed gradients fall short. The built-in database is intentionally small, so treat hits as prompts to double-check the official plate rather than automation you can blindly trust.
- **CAPSManager (`src/passbrief/briefing/caps.py:9`)** *(Certain)* – Calculates CAPS deployment altitudes relative to field elevation and density altitude, then tailors emergency callouts for departure profiles. Its outputs feed both the textual brief and the phased flavor text to reinforce Cirrus-specific muscle memory.
- **FlavorTextManager (`src/passbrief/briefing/flavortext.py:9`)** *(High confidence)* – Turns raw performance numbers into a scripted three-phase takeoff brief that pilots can rehearse out loud. It blends runway condition notes, CAPS triggers, and wind components so the spoken briefing aligns with the calculated margins.
- **ChatGPTAnalysisManager (`src/passbrief/briefing/chatgpt.py:12`)** *(Certain)* – Wraps optional AI analysis for hazard spotting, passenger messaging, and NOTAM filtering. The `available` flag keeps AI work strictly additive: no API key means the rest of the system runs untouched, and every generated paragraph is clearly marked as advisory.
- **ConsoleIO (`src/passbrief/io.py:30`)** *(Certain)* – Default input/output layer that powers the CLI prompts, making it trivial to drop in scripted or GUI-driven alternatives later. Tests and automation use this abstraction to simulate interactive flows without rewriting core logic.
- **Domain models (`src/passbrief/models.py:23`)** *(Certain)* – Immutable dataclasses (e.g., `WeatherSnapshot`, `PerformanceSummary`, `WindComponents`) that standardize how managers hand data to each other. Because they behave like mappings, you can integrate them into legacy formatting code while enjoying type safety and explicit field names.
## Safety Guardrails You Should Respect
- *(Certain)* Embedded POH performance data (`src/passbrief/performance/data.py:1`) keeps every calculation deterministic and traceable back to the official manual. If you ever regenerate these tables, archive the source references and rerun the comprehensive tests so future pilots can trust the new baseline.
- *(Certain)* Rounding policies and weather age limits in `Config` exist to bias calculations toward conservative outcomes. Relaxing them can silently erode margins, so pair any change with updated documentation, new unit tests, and a real-world reason (e.g., matching a revised POH supplement).
- *(High confidence)* `WeatherManager.fetch_metar()` tags snapshots with `age_minutes` and `source`, which the CLI echoes to the pilot. Use that metadata to pause when the METAR is stale or manually entered; the tool will happily continue, but cockpit judgment should take over.
- *(Certain)* Magnetic variation logic records whether headings came from WMM data, manual entry, or regional approximation (`src/passbrief/airports/manager.py:41`). Always mention that provenance when briefing crosswinds so nobody assumes a real-time API call succeeded when it actually fell back to an approximation.
- *(High confidence)* Manual weather and airport workflows keep PassBrief usable offline, but they also move verification back onto the human pilot. Capture those manual inputs in your flight log or kneeboard so you can audit the numbers later if something feels off during the takeoff roll.
- *(Certain)* `ChatGPTAnalysisManager` only engages when `available` is true, and every AI-generated paragraph is framed as advisory. Treat the output like an extra set of eyes, not a certified dispatcher; if it contradicts the POH or your preflight, the human wins.
- *(High confidence)* Built-in health checks such as `PerformanceCalculator.run_safety_critical_tests()` and `AirportManager.run_magnetic_variation_tests()` are there for quick confidence sweeps. Run them after touching the respective code paths and before flying with a freshly modified build.
## Getting Hands-On
Once you install in editable mode (`pip install -e .`), you can iterate quickly between code tweaks, tests, and live CLI runs.

- *(Certain)* Launch an interactive session with `python -m passbrief.briefing.generator` to experience the workflow exactly as end users will (`src/passbrief/briefing/generator.py:28`).
- *(Certain)* Run `pytest` to execute the focused suites, especially `tests/test_sr22t_comprehensive.py:1`, `tests/test_workflow.py:1`, and `tests/test_retry_logic.py:1` before sharing changes.
- *(High confidence)* Use the `APP_LOG=full` flag (see `README.md:56`) when you need verbose tracing of METAR calls and magnetic variation fallbacks.
- *(High confidence)* To experiment safely, inject a custom `IOInterface` implementation (`src/passbrief/io.py:10`) so you can script inputs without touching production code.
- *(High confidence)* When testing AI flows, stub `ChatGPTAnalysisManager.available` or supply a dummy API key via `_load_api_key()` to avoid accidental network calls in restricted environments.
- Common pitfalls: forgetting to normalize runway names (lean on `_normalize_runway_input()`) and mixing imperial/metric units when feeding manual data.

### Learning Strategy
- *(Certain)* Start with a single end-to-end run of the sequential workflow while tracing the call stack; note where each manager is invoked and log questions for later research.
- *(High confidence)* Pair code reading with small notebook experiments—recreate density altitude or wind component calculations in isolation to confirm your understanding.
- *(High confidence)* Track progress by maintaining a personal checklist: "Garmin import understood," "Weather fallbacks rehearsed," "CAPS outputs validated," and update it after each focused session.

### Study Schedule (Sample 2-week ramp)
- **Week 1 (6-8 hrs):** Day 1-2 read `docs/architecture.md:1` and `src/passbrief/briefing/generator.py:28`, Day 3 rehearse the CLI with and without Garmin data, Day 4 replicate core performance tests.
- **Week 2 (6-8 hrs):** Day 1 deep-dive `WeatherManager` and `AirportManager`, Day 2 explore AI and flavor text managers, Day 3 contribute a small enhancement or bugfix with tests, Day 4 shadow a real-world briefing and compare outputs.

## Glossary
- **CAPS** – Cirrus Airframe Parachute System; an airframe parachute that deploys above specific altitudes. PassBrief models its decision gates in `CAPSManager` (`src/passbrief/briefing/caps.py:9`).
- **Climb Gradient** – Required vertical performance expressed in feet per nautical mile to clear obstacles or satisfy SID procedures. Calculated by `PerformanceCalculator.calculate_climb_gradients()` (`src/passbrief/performance/calculator.py:390`).
- **Density Altitude** – Pressure altitude corrected for temperature; higher values reduce climb and takeoff performance. Derived via `PerformanceCalculator.calculate_density_altitude()` (`src/passbrief/performance/calculator.py:127`).
- **Garmin Pilot Briefing** – PDF export from the Garmin Pilot app containing flight plan, weather, and NOTAM data. Parsed by `GarminPilotBriefingManager` (`src/passbrief/garmin/pilot.py:13`).
- **METAR** – Meteorological Aerodrome Report; the standard aviation weather observation. Fetched and validated by `WeatherManager.fetch_metar()` (`src/passbrief/weather/manager.py:31`).
- **Magnetic Variation (Mag Var)** – Difference between true north and magnetic north; necessary for accurate runway heading and wind component math. Handled in `AirportManager._true_to_magnetic_heading()` (`src/passbrief/airports/manager.py:259`).
- **POH** – Pilot’s Operating Handbook; the authoritative aircraft manual whose tables feed `performance/data.py`.
- **SID** – Standard Instrument Departure; published procedure with climb requirements and routing. Sampled by `SIDManager.get_applicable_sids()` (`src/passbrief/briefing/sid.py:13`).
- **TFR** – Temporary Flight Restriction; airspace limitations often surfaced in Garmin briefings and filtered in `ChatGPTAnalysisManager._filter_relevant_notams()` (`src/passbrief/briefing/chatgpt.py:479`).
- **Wind Components** – Headwind and crosswind values resolved relative to runway heading to evaluate limits. Produced by `PerformanceCalculator.calculate_wind_components()` (`src/passbrief/performance/calculator.py:195`).

## Where to Go Next
- *(Certain)* Study `docs/architecture.md:1` alongside this guide to map narrative explanations back to module boundaries.
- *(Certain)* Review the dataclasses in `src/passbrief/models.py:23` so you know exactly what structures each manager expects and returns.
- *(High confidence)* Explore the Garmin integration under `src/passbrief/garmin/` to confirm which directories are scanned on your platform and adjust if you rely on custom storage *(Speculative: on Pythonista you may need to add iCloud paths)*.
- *(Certain)* Inspect `scripts/build_for_pythonista.py:1` if you plan to ship a single-file build; understanding the bundling process helps when you add new dependencies.
- *(High confidence)* Use `tests/test_retry_logic.py:1` as a template when adding new resiliency checks (e.g., additional weather sources or performance guardrails).
- *(Certain)* Capture open questions in `docs/` or as GitHub issues so the team can align on next steps; this refactor thrives when onboarding feedback loops stay short.
